import numpy as np
import time
import os, shlex
#from subprocess import Popen, PIPE, STDOUT, TimeoutExpired
import utilix
from utilix.batchq import *
print(utilix.__file__)

class Submit(object):
    '''
        Take maximum number of nodes to use at once
        Submit each group to a node and excute
    '''
    def name(self):
        return self.__class__.__name__

    def execute(self, *args, **kwargs):
        eval('self.{name}(*args, **kwargs)'.format(name = self.name().lower()))

    def submit(self, loop_over=[], max_num_submit=10, nmax=3):
        _start = 0
        self.max_num_submit = max_num_submit
        self.loop_over = loop_over
        self.p = True

        index = _start
        while (index < len(self.loop_over) and index < nmax):
            if (self.working_job() < self.max_num_submit):
                self._submit_single(loop_index=index,
                                    loop_item=self.loop_over[index])

                time.sleep(1.0)
                index += 1

    # check my jobs
    def working_job(self):
        cmd='squeue --user={user} | wc -l'.format(user = 'yuanlq')
        jobNum=int(os.popen(cmd).read())
        return  jobNum -1

    def _submit_single(self, loop_index, loop_item):
        jobname = 'process_events%s'%(loop_item)
        run_id = loop_item
        # Modify here for the script to run
        jobstring = "python /home/yuanlq/software/midwayjob/process_events.py %s"%(run_id)
        print(jobstring)

        # Modify here for the log name
        utilix.batchq.submit_job(
            jobstring, log='/home/yuanlq/.tmp_job_submission/cuts_basic/process_events%s.log'%(run_id), 
            partition='caslake', qos='caslake',
            account='pi-lgrandi', jobname=jobname,
            delete_file=True, dry_run=False, mem_per_cpu=5000,
            container='xenonnt-2024.01.1.simg',
            cpus_per_task=1)

p = Submit()

# Modify here for the runs to process
loop_over = ['049855', '049853', '049850', '049846', '049844', '049843',
       '049842', '049792', '049786', '049782', '049778', '049777',
       '049773', '049769', '049764', '049763', '049762', '049737',
       '049736', '049735', '049734', '049726', '049725', '049722',
       '049720', '049719', '049717', '049716', '049715', '049712',
       '049707', '049701', '049697', '049685', '049683', '049679',
       '049676', '049674', '049671', '049668', '049667', '049666',
       '049663', '049660', '049658', '049656', '049655', '049654',
       '049645', '049644', '049641', '049639', '049637', '049635',
       '049634', '049629', '049624', '049619', '049611', '049610',
       '049608', '049601', '049583', '049578', '049576', '049575',
       '049573', '049571', '049570', '049568', '049567', '049566',
       '049559', '049557', '049554', '049546', '049542', '049541',
       '049540', '049539', '049538', '049533', '049531', '049528',
       '049524', '049509', '049507', '049506', '049504', '049500',
       '049499', '049498', '049496', '049493', '049492', '049489',
       '049487', '049486', '049482', '049481', '049479', '049472',
       '049467', '049459', '049455', '049454', '049453', '049452',
       '049447', '049446', '049445', '049444', '049441', '049440',
       '049437', '049436', '049433', '049432', '049187', '049185',
       '049183', '049182', '049181', '049179', '049178', '049176',
       '049175', '049174', '049173', '049172', '049165', '049140',
       '049139', '049138', '049137', '049134', '049133', '049131',
       '049130', '049127', '049125', '049124', '049121', '049119',
       '049118', '049114', '049113', '049101', '049100', '049099',
       '049097', '049096', '049095', '049093', '049091', '049089',
       '049083', '049082', '049080', '049079', '049077', '048919',
       '048904', '053362', '053355', '053349', '053346', '053337',
       '053209', '053208', '053206', '053204', '053203', '053202',
       '053201', '053199', '053197', '053196', '053195', '053194',
       '053189', '053170', '053168', '053167', '053163', '053162',
       '053160', '053157', '053156', '053155', '053154', '053148',
       '053147', '053145', '053142', '053141', '053136', '053054',
       '053053', '053052', '053049', '053048', '053047', '053046',
       '053045', '053040', '053016', '053015', '053012', '053011',
       '053010', '053005', '053004', '053003', '052995', '052991',
       '052989', '052988', '052987', '052984', '052983', '052982',
       '052981', '052980', '052867', '052864', '052863', '052862',
       '052861', '052857', '052856', '052853', '052850', '052849',
       '052846', '052840', '052836', '052833', '052828', '052826',
       '052822', '052821', '052820', '052818', '052815', '052813',
       '052812', '052811', '052810', '052807', '052805', '052804',
       '052803', '052800', '052687', '052686', '052683', '052682',
       '052681', '052680', '052679', '052675', '052674', '052673',
       '052668', '052667', '052666', '052662', '052659', '052655',
       '052654', '052648', '052647', '052646', '052645', '052641',
       '052638', '052634', '052626', '052621', '052516', '052513',
       '052510', '052507', '052504', '052501', '052498', '052495',
       '052492', '052486', '052483', '052480', '052477', '052474',
       '052471', '052468', '052465', '052456', '052453', '052450',
       '052444', '052441', '052438', '052435', '052429', '052426',
       '052420', '052417', '052411', '052405', '052402', '052399',
       '052393', '052390', '052387', '052214', '052204', '052035',
       '051559', '050917', '050896', '050869', '050860', '050705',
       '049912', '049297', '049287', '048657', '048259', '048253',
       '048237', '047612', '043280', '053483', '053293', '053245',
       '053224', '053222', '053221', '053216', '053120', '053059',
       '053057', '052977', '052965', '052960', '052949', '052894',
       '052889', '052747', '052727', '052724', '052612', '052611',
       '052606', '052605', '052604', '052603', '052601', '052600',
       '052596', '052593', '052572', '052571', '052565', '052562',
       '052551', '052545', '052543', '052383', '052360', '052344',
       '052312', '052310', '052296', '052235', '052088', '050847',
       '050840', '050837', '050836', '050743', '050663', '050658',
       '050100', '050099', '050045', '049861', '049860', '049390',
       '049389', '049382', '049381', '049377', '049374', '049371',
       '049368', '049337', '049328', '049326', '049322', '049320', '049315', '049313', '049298', '049201',
       '049199', '048558', '048552', '048543', '048539', '048458',
       '048457', '048399', '048373', '048360', '048357', '048356',
       '048012', '046927', '046903', '046496', '045285', '045180',
       '044066', '043111', '053418', '053331', '053328', '053327',
       '053325', '053322', '053321', '053320', '053319', '053298',
       '053297', '052904', '052900', '052144', '047342', '046942',
       '046741', '044836', '044604', '043669', '048003', '048002',
       '048001', '047999', '047998', '047997', '047996', '047995',
       '047994', '047993', '047992', '047991', '047989', '047988',
       '047987', '047986', '047985', '047984', '047983', '047982',
       '047981', '047980', '047979', '047978', '047977', '047976',
       '047975', '047973', '047972', '047971', '047970', '047969',
       '047968', '047965', '047964', '047962', '047961', '047960',
       '047959', '047958', '047957', '047956', '047954', '047953',
       '047930', '047929', '047928', '047926', '047925', '047924',
       '047923', '047922', '047921', '047920', '047919', '047918',
       '047917', '047916', '047915', '047914', '047913', '047912',
       '047911', '047910', '047909', '047908', '047907', '047902',
       '047900', '047899', '047898', '047896', '047895', '047894',
       '047892', '047891', '047890', '047889', '047888', '047887',
       '047886', '047885', '047884', '047883', '047882', '047881',
       '047878', '047874', '047873', '047872', '047871', '047870',
       '047869', '047868', '047867', '047861', '047859', '047858',
       '047857', '047854', '047852', '047851', '047850', '047849',
       '047848', '047847', '047845', '047844', '047843', '047842',
       '047841', '047839', '047837', '047836', '047834', '047833',
       '047831', '047830', '047822', '047821', '047820', '047818',
       '047811', '047809', '047807', '047806', '047805', '047804',
       '047802', '047800', '047799', '047798', '047797', '047795',
       '047794', '047791', '047790', '047788', '047786', '047785',
       '047782', '047781', '047779', '047778', '047777', '047776',
       '047775', '047774', '047773', '047770', '047769', '047768',
       '047767', '047766', '047765', '047764', '047763', '047762',
       '047761', '047760', '047759', '047758', '047756', '047755',
       '047753', '047752', '047751', '047750', '047749', '047748',
       '047747', '047746', '047745', '047744', '047743', '047742',
       '047740', '047738', '047737', '047736', '047735', '047734',
       '047733', '047732', '047731', '047730', '047727', '047726',
       '047724', '047723', '047721', '047720', '047718', '047717',
       '047716', '047712', '047711', '047710', '047709', '047707',
       '047704', '047703', '047702', '047701', '048205', '048204',
       '048203', '048202', '048201', '048197', '048196', '048195',
       '048194', '048191', '048187', '048186', '048184', '048183',
       '048181', '048180', '048179', '048178', '048177', '048176',
       '048175', '048174', '048171', '048170', '048169', '048167',
       '048166', '048165', '048163', '048162', '048160', '048158',
       '048157', '048156', '048155', '048154', '048153', '048152',
       '048151', '048149', '048148', '048147', '048146', '048124',
       '048123', '048122', '048121', '048120', '048119', '048118',
       '048117', '048116', '048115', '048114', '048113', '048112',
       '048111', '048110', '048109', '048108', '048106', '048105',
       '048103', '048102', '048101', '048100', '048098', '048097',
       '048096', '048094', '048093', '048092', '048091', '048090',
       '048089', '048088', '048087', '048086', '048085', '048084',
       '048082', '048081', '048080', '048079', '048077', '048076',
       '048075', '048074', '048073', '048072', '048071', '048069',
       '048068', '048066', '048065', '048064', '048063', '048062',
       '048060', '048058', '048057', '048055', '048054', '048052',
       '048051', '048050', '048049', '048046', '048044', '048043',
       '048042', '048041', '048040', '048039', '048038', '048037',
       '048034', '048025', '048024', '051983', '051974', '051969',
       '051968', '051967', '051966', '051964', '051963', '051962',
       '051961', '051960', '051959', '051958', '051957', '051956',
       '051955', '051954', '051953', '051952', '051951', '051950',
       '051947', '051946', '051944', '051939', '051937', '051936',
       '051935', '051934', '051933', '051932', '051930', '051928', '051927', '051924', '051923', '051922',
       '051921', '051920', '051919', '051916', '051915', '051914',
       '051913', '051911', '051910', '051909', '051907', '051906',
       '051905', '051904', '051887', '051742', '051741', '051740',
       '051731', '051729', '051726', '051723', '051722', '051721',
       '051720', '051718', '051717', '051716', '051715', '051711',
       '051710', '051709', '051707', '051706', '051702', '051700',
       '051699', '051696', '051693', '051691', '051687', '051686',
       '051684', '051682', '051654', '051650', '051648', '051645',
       '051644', '051642', '051640', '051430', '051427', '051425',
       '051389', '051386', '051385', '051383', '051758', '051757',
       '051754', '051753', '051752', '051751', '051750', '051749',
       '051748', '051747', '051746', '051743', '051680', '051679',
       '051676', '051675', '051674', '051673', '051672', '051669',
       '051668', '051667', '051666', '051665', '051662', '051661',
       '051660', '051659', '051656', '051635', '051634', '051633',
       '051632', '051629', '051628', '051627', '051626', '051623',
       '051622', '051620', '051619', '051616', '051615', '051614',
       '051612', '051608', '051607', '051606', '051605', '051601',
       '051600', '051599', '051598', '051595', '051594', '051593',
       '051592', '051591', '051588', '051587', '051586', '051585',
       '051531', '051528', '051527', '051524', '051521', '051520',
       '051519', '051518', '051517', '051514', '051513', '051512',
       '051511', '051508', '051487', '051486', '051482', '051460',
       '051458', '051457', '051456', '051454', '051453', '051452',
       '051450', '051449', '051447', '051446', '051445', '051443',
       '051442', '051440', '051439', '051438', '051420', '051412',
       '051408', '051407', '051406', '051405', '051403', '051401',
       '051400', '051399', '051398', '051396', '051394', '051392',
       '051390', '051371', '051370', '051369', '051368', '051365',
       '051364', '051363', '051362', '051361', '051358', '051357',
       '051356', '051355', '051351', '051350', '051349', '051348',
       '051345', '051344', '051343', '051342', '051338', '051337',
       '051336', '051335', '051334', '051331', '051330', '051328',
       '051327', '051324', '051323', '051322', '051321', '051320',
       '051317', '051316', '051315', '051314', '051313', '051310',
       '051309', '051308', '051307', '051306', '051303', '051302',
       '051301', '051300', '051299', '051296', '051295', '051294',
       '051293', '051292', '051289', '051288', '051287', '051285',
       '051282', '051280', '051279', '051275', '051274', '051273',
       '051272', '051271', '051268', '051267', '051265', '051264',
       '051261', '051260', '051259', '051258', '051257', '051254',
       '051253', '051252', '051251', '051249', '051247', '051246',
       '051245', '051244', '051218', '051217', '051214', '051213',
       '051211', '051210', '051208', '051207', '051206', '051204',
       '051203', '051201', '051200', '051199', '051197', '051196',
       '051194', '051193', '051192', '051190', '051189', '051187',
       '051186', '051185', '051183', '051180', '051179', '051178',
       '051176', '051173', '051172', '051171', '051169', '051168',
       '051166', '051165', '051164', '051162', '051161', '051158',
       '051157', '051155', '051154', '051152', '051150', '051148',
       '051147', '051144', '051143', '051141', '051140', '051138',
       '051137', '051136', '051134', '051133', '051131', '051129',
       '051127', '051126', '051124', '051123', '051122', '051120',
       '051119', '051117', '051116', '051114', '051113', '051112',
       '051110', '051109', '051107', '051106', '051102', '051100',
       '051099', '051098', '051096', '051093', '051092', '051090',
       '051083', '051078', '051077', '051076', '051073', '051071',
       '051070', '051069', '051067', '051060', '051057', '051053',
       '051050', '051049', '051045', '051043', '051038', '051036',
       '051034', '051032', '051031', '051029', '051022', '051017',
       '051016', '051014', '051013', '051011', '051009', '051006',
       '051003', '051002', '051000', '050997', '050996', '050993',
       '050992', '050990', '050989', '050986', '050985', '050983',
       '050981', '050979', '050976', '050975', '050974', '050971',
       '050969', '050968', '050965', '050964', '050962', '050961',
       '050959', '050958', '050957', '050955', '050954', '050952',
       '050951', '051377', '051376', '050021', '050019', '050017',
       '050016', '050015', '050014', '050013', '050012', '050011',
       '050010', '050009', '050008', '050007', '050006', '050005',
       '050004', '050003', '050002', '050001']

print('Runs to process: ', len(loop_over))

p.execute(loop_over=loop_over, max_num_submit=2000, nmax=10000)
